name: Análise Diária de Criptomoedas

on:
  schedule:
    # ESTRATÉGIA: Múltiplos horários para garantir execução às 21:05 GMT-3
    # Sistema de lock previne execuções duplicadas
    
    # Horário principal: 00:05 UTC = 21:05 GMT-3
    - cron: '5 0 * * *'
    
    # Backup 1: 00:04 UTC = 21:04 GMT-3 (caso principal atrase)
    - cron: '4 0 * * *'
    
    # Backup 2: 00:06 UTC = 21:06 GMT-3 (caso principal atrase)
    - cron: '6 0 * * *'
    
    # Backup 3: 23:55 UTC = 20:55 GMT-3 (10min antes, caso todos atrasem)
    - cron: '55 23 * * *'
    
    # Backup 4: 00:15 UTC = 21:15 GMT-3 (10min depois, caso todos falhem)
    - cron: '15 0 * * *'
    
  workflow_dispatch: # Permite execução manual

jobs:
  analisar-criptos:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout do código
      uses: actions/checkout@v3
    
    - name: Configurar Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Instalar dependências
      run: |
        pip install yfinance python-dotenv requests pytz
    
    - name: Criar arquivo .env com secrets do bot
      run: |
        cat > backend/quantum-trades-backend/.env << EOF
        TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID=${{ secrets.TELEGRAM_CHAT_ID }}
        EOF
    
    - name: Executar análise com sistema de lock
      run: |
        cd backend/quantum-trades-backend
        chmod +x executar_analise_diaria.py
        python3 executar_analise_diaria.py
    
    - name: Upload de logs de execução
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: logs-execucao-${{ github.run_number }}
        path: backend/quantum-trades-backend/logs/
        retention-days: 30
    
    - name: Verificar resultado
      if: always()
      run: |
        echo "========================================="
        echo "Análise concluída!"
        echo "Verifique:"
        echo "1. Telegram para a mensagem"
        echo "2. Artifacts para logs detalhados"
        echo "========================================="
